services:
  frontend:
    image: nginx:alpine
    restart: unless-stopped
    volumes:
      - ./frontend/index.html:/usr/share/nginx/html/index.html:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-frontend.rule=Host(`${APP_DOMAIN}`) && !PathPrefix(`/api`)"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-frontend.entrypoints=websecure"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-frontend.tls.certresolver=letsencrypt"
      - "traefik.http.services.${COMPOSE_PROJECT_NAME}-frontend.loadbalancer.server.port=80"
    networks:
      - gateway

  backend:
    image: hashicorp/http-echo
    restart: unless-stopped
    command: ["-text", "Hello from traefik-sample backend!", "-listen", ":5678"]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-backend.rule=Host(`${APP_DOMAIN}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-backend.entrypoints=websecure"
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-backend.tls.certresolver=letsencrypt"
      - "traefik.http.services.${COMPOSE_PROJECT_NAME}-backend.loadbalancer.server.port=5678"
      # Strip /api prefix before forwarding to backend
      - "traefik.http.routers.${COMPOSE_PROJECT_NAME}-backend.middlewares=${COMPOSE_PROJECT_NAME}-strip-api"
      - "traefik.http.middlewares.${COMPOSE_PROJECT_NAME}-strip-api.stripprefix.prefixes=/api"
    networks:
      - gateway

networks:
  gateway:
    external: true
